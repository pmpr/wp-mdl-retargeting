(()=>{"use strict";const t=class{constructor(t={}){this.db=t.database,this.expireMS=t.expireMS||864e5,this.initDB()}initDB(){const t=this.db.addTable("product");t.addSchema("slug",{type:String,default:""}).addSchema("title",{type:String}).addSchema("metadata").addSchema("permalink",{type:String}).addSchema("parent_id",{type:Number,default:0}).addSchema("taxonomies").addSchema("product_id",{type:Number,default:0,required:!0}).addSchema("fetched_at").addSchema("sale_price").addSchema("category_id",{type:Number,default:0}).addSchema("published_at").addSchema("regular_price");const e=PRHelper.getSetting().getOption("product_fields",[]);t&&PRHelper.getType().each(e,((e,i)=>{t.addSchema(i,e)}))}async getProducts(t,e={}){let i=[];e.product_id=t,i=await this.db.getTable("product").getList({query:e});const a=new Set(i.map((t=>t.product_id))),n=t.filter((t=>!a.has(t))),s=await this.fetchProducts(n);return s&&(await PRHelper.getType().each(s,(async t=>{await this.saveProduct(t)})),i=[...i,...s]),i}async getProduct(t,e={}){e.product_id=t,e.product_url=t;let i=await this.db.getTable("product").getSingle({query:e});return i&&!PRHelper.getTool().isTimePassed(i.fetched_at,24)||(i=await this.fetchProduct(t),await this.saveProduct(i,i.id??null)),i}async saveProduct(t,e=null){const i=this.db.getTable("product");let a=null;a=e?await i.getSingle({query:{id:e}}):await i.getSingle({query:{product_id:t.product_id}}),t.fetched_at=Date.now(),a?i.update(a.id,t):i.add(t)}fetchProduct(t){return new Promise(((e,i)=>{PRHelper.getRequest().restGet("core/retargeting/get-product/").onSuccess(((t,a)=>{a.product?e(a.product):i(null)})).onError((t=>{console.log(t),i(null)})).addNonce().send({product:t})}))}fetchProducts(t){return new Promise(((e,i)=>{PRHelper.getRequest().restGet("core/retargeting/get-products/").onSuccess((t=>{t.products?e(t.products):i(null)})).onError((t=>{console.log(t),i(null)})).addNonce().send({products:t})}))}};const e=class{constructor(t={}){this.db=t.database,this.productID=t.productID||0,this.eventWeights=t.eventWeights,this.eventMaximums=t.eventMaximums,this.syncInterval=t.syncInterval||3e4,this.interestThreshold=parseInt(t.interestThreshold||30),this.startTime=0,this.dwellTime=0,this.lastY=window.scrollY,this.totalDelta=0,this.scrollDepth=0,this.scrollTimeout=null,this.interactionCount=0,this.initDB(),this.init()}init(){const t=PRHelper.getHook();this.productID&&(this.onScroll=this.onScroll.bind(this),t.on("scroll",this.onScroll),this.handleInteractionClick=this.handleInteractionClick.bind(this),t.on("click",this.handleInteractionClick),this.onLeavePage=this.onLeavePage.bind(this),this.onVisibilityChange=this.onVisibilityChange.bind(this),t.on("beforeunload",this.onLeavePage),t.on("visibilitychange",this.onVisibilityChange)),this.handleLinkClick=this.handleLinkClick.bind(this),t.on("click",this.handleLinkClick,"a[href]"),this.handleCartAction=this.handleCartAction.bind(this),t.on("click",this.handleCartAction,"a[href], button[type=submit]"),this.checkPendingClickOnLoad=this.checkPendingClickOnLoad.bind(this),t.on("load",this.checkPendingClickOnLoad)}stop(){PRHelper.getHook().removeListener("scroll",this.onScroll)}onLeavePage(){"hidden"===document.visibilityState&&(this.dwellTime+=Date.now()-this.startTime),this.addPageEvent()}onVisibilityChange(){"visible"===document.visibilityState?this.onVisible():this.onHidden()}onVisible(){this.startTime=Date.now()}onHidden(){this.startTime&&(this.dwellTime+=Date.now()-this.startTime,this.startTime=0)}handleCartAction(t){const e=PRHelper.getHTML(),i=e.getTarget(t);let a=e.getData(i,"productId");if(PRHelper.getType().isEmpty(a)&&e.is(i,"button")&&(a=e.getValue(i)),a){let t="add",n=e.getParent(i,".add_to_cart_button");e.isElement(n)||(n=e.getParent(i,".single_add_to_cart_button")),e.isElement(n)||(t="remove",n=e.getParent(i,".remove_from_cart_button")),e.isElement(n)&&this.addCartEvent(a,t)}}handleInteractionClick(t){const e=PRHelper.getHTML(),i=e.getTarget(t);if(e.getParent(i,"a[href]"))return;if(e.is(i,"button")&&["submit","reset"].includes(i.type))return;if(e.getParent(i,"form"))return;const a=e.getAttribute(i,"role");(a&&a.includes("tab")||e.is(i,"button")||e.is(i,"select")||e.is(i,"input[type=radio]")||e.is(i,"input[type=button]")||e.is(i,"input[type=checkbox]")||e.is(i,"input[type=checkbox]")||this.isInteractive(i))&&this.interactionCount++}checkPendingClickOnLoad(){if(this.isProductPage()){const t=PRHelper.getStorage().get("pr_pending_click");t&&this.addClickEvent(t.referrer||document.referrer||"")}PRHelper.getStorage().remove("pr_pending_click")}handleLinkClick(t){const e=PRHelper.getHTML(),i=e.getTarget(t),a=e.getAttribute(i,"href");if(!a)return;const n=PRHelper.getSetting().getOption("product_link_pattern","");if(!n)return;if(!a.includes(n))return;const s=a.split(n)[1]?.replace(/\/$/,"");s&&PRHelper.getStorage().set("pr_pending_click",{referrer:window.location.href,timestamp:Date.now()})}isInteractive(t){const e=window.getComputedStyle(t),i="function"==typeof t.onclick||t.hasAttribute("onclick");return["DIV","SPAN","IMG"].includes(t.tagName)&&(i||"pointer"===e.cursor)}onScroll(){this.scrollTimeout||(this.scrollTimeout=setTimeout((()=>{const t=window.scrollY,e=Math.abs(t-this.lastY);this.totalDelta+=e,this.lastY=t,this.scrollDepth=Math.max(this.scrollDepth,(t+window.innerHeight)/document.body.scrollHeight),this.scrollTimeout=null}),200))}getScrollActivity(){const t=document.body.scrollHeight-window.innerHeight;return t<=0?0:this.totalDelta/t}initDB(){const t=this.db.addTable("page_event"),e=this.db.addTable("cart_event"),i=this.db.addTable("click_event"),a=this.db.addTable("interest");t.addSchema("synced").addSchema("dwell_time").addSchema("product_id").addSchema("scroll_depth").addSchema("scroll_activity").addSchema("interaction_count"),i.addSchema("synced").addSchema("referrer").addSchema("product_id"),e.addSchema("action").addSchema("synced").addSchema("product_id"),a.addSchema("score").addSchema("synced").addSchema("product_id")}getInterestedProducts(){return this.db.getTable("interest").getPluck({limit:10,query:{score:{operator:">=",value:this.interestThreshold}}},"product_id")}getLastViewdProducts(){return this.db.getTable("page_event").getPluck({limit:10,groupBy:"product_id"},"product_id")}async addPageEvent(t=!1){if(this.isProductPage())if(t){const t=PRHelper.getStorage().get("last_page_event");t&&(await this.db.getTable("page_event").add(t),await this.calculateInterestScore(this.productID),PRHelper.getStorage().remove("last_page_event"))}else PRHelper.getStorage().set("last_page_event",{id:PRHelper.getTool().generateUUID(),synced:!1,dwell_time:this.dwellTime,product_id:this.productID,scroll_depth:this.scrollDepth,scroll_activity:this.getScrollActivity(),interaction_count:this.interactionCount})}async addClickEvent(t){const e={id:PRHelper.getTool().generateUUID(),synced:!1,referrer:t,product_id:this.productID};await this.db.getTable("click_event").add(e),await this.calculateInterestScore(this.productID)}async addCartEvent(t,e){const i={id:PRHelper.getTool().generateUUID(),synced:!1,action:e,product_id:parseInt(t)};await this.db.getTable("cart_event").add(i),await this.calculateInterestScore(t)}async calculateInterestScore(t){const e=this.db.getTable("page_event"),i=this.db.getTable("cart_event"),a=this.db.getTable("click_event"),n={query:{product_id:t}},s=await e.getList(n),r=await i.getList(n),c=await a.getList(n),d=r.filter((t=>"add"===t.action)).length,o=r.filter((t=>"remove"===t.action)).length,l={view:s.length,click:c.length,dwell_time:this.sum(s.map((t=>t.dwell_time))),add_to_cart:Math.max(d-o,0),interaction:this.sum(s.map((t=>t.interaction_count))),scroll_depth:this.max(s.map((t=>t.scroll_depth))),scroll_activity:this.max(s.map((t=>t.scroll_activity))),unique_referrers:new Set(c.map((t=>t.referrer))).size};let h=0;for(const t in l){const e=this.eventMaximums[t]??1,i=this.eventWeights[t]??0;h+=Math.min(l[t]/e,1)*i}const u=Math.max(Math.max(...s.map((t=>t.created_at))),c.length?Math.max(...c.map((t=>t.created_at))):0,r.length?Math.max(...r.map((t=>t.created_at))):0),g=(Date.now()-u)/36e5,p=Math.exp(-.1*g),m=Math.ceil(h*p),_=this.db.getTable("interest"),b=await _.getSingle({query:{product_id:t}});let y=!1,P=0;b?(_.update(b.id,{score:m}),P=b.id,y=b.synced||m>=this.interestThreshold):(P=await _.add({score:m,product_id:t}),y=m>=this.interestThreshold),y&&PRHelper.getRequest().restPost("core/retargeting/sync-interest/").onSuccess((async(t,e)=>{_.update(P,{synced:!0})})).onError((t=>{console.warn("Interest score sync failed:",t)})).addNonce().send({score:m,product_id:t,interest_id:P})}mean(t){return t.length?this.sum(t)/t.length:0}sum(t){return t.length?t.reduce(((t,e)=>t+e),0):0}max(t){return t.length?Math.max(...t):0}async sync(){const t=(await db.getAll("events",(t=>!t.synced))).filter((t=>{if("add_to_cart"===t.type)return!0;if("page_view"===t.type&&t.data?.productID){return(this.localInterest[t.data.productID]||0)>=this.interestThreshold}return!1}));t.length&&PRHelper.getRequest().restPost(this.syncPath).onSuccess(((e,i)=>{PRHelper.getType().each(t,(async t=>{await this.db.update("events",t.id,{synced:!0})}))})).onError((t=>{console.warn("Sync failed:",t)})).send({events:t})}initAutoSync(){this.syncInterval>0&&setInterval((()=>this.sync()),this.syncInterval),PRHelper.getHook().on("visibilitychange",(()=>{"hidden"===document.visibilityState&&this.sync()}))}async clear(){await this.db.getTable("interest").clear(),await this.db.getTable("page_event").clear(),await this.db.getTable("cart_event").clear(),await this.db.getTable("click_event").clear()}isProductPage(){return this.productID&&this.productID>0}};!function(){const i=PRHelper.getHook(),a=PRHelper.getHTML(),n=PRHelper.getType(),s=PRHelper.getSetting(),r=PRHelper.getTemplate();i.on("DOMContentLoaded",(async()=>{const i=PRHelper.getDatabase().addDatabase("pr_retargeting"),c=new t({database:i}),d=new e({database:i,productID:s.getOption("product_id",0),eventWeights:s.getOption("event_weights",{}),syncInterval:s.getOption("sync_interval",30),eventMaximums:s.getOption("event_maximums",{}),interestThreshold:s.getOption("interest_threshold",50)});await i.init(),d.addPageEvent(!0);const o=a.getElements('.pr-tpl[data-type="most-interested"]');a.isList(o)&&d.getInterestedProducts().then((t=>{h(t,o,"retargeting_most_interested")})).catch((t=>console.log(t)));const l=a.getElements('.pr-tpl[data-type="recently-viewed"]');function h(t,e,i){n.isEmpty(t)||n.each(e,(e=>{const n=a.getData(e,"query",{});c.getProducts(t,n).then((t=>{r.load(`script.pr-js-tpl#${i}`,{items:t})})).catch((t=>console.log(t)))}))}!n.isEmpty(l)&&a.isList(l)&&d.getLastViewdProducts().then((async t=>{h(t,l,"retargeting_recently_viewed")})).catch((t=>console.log(t)))}))}()})();