(()=>{"use strict";const t=class{constructor(t={}){this.db=t.database,this.expireMS=t.expireMS||864e5,this.initDB()}initDB(){const t=this.db.addTable("product");t.addSchema("slug",{type:String,default:""}).addSchema("title",{type:String}).addSchema("metadata").addSchema("permalink",{type:String}).addSchema("parent_id",{type:Number,default:0}).addSchema("taxonomies").addSchema("product_id",{type:Number,default:0,required:!0}).addSchema("fetched_at").addSchema("sale_price").addSchema("category_id",{type:Number,default:0}).addSchema("published_at").addSchema("regular_price");const e=PRHelper.getSetting().getOption("product_fields",[]);t&&PRHelper.getType().each(e,((e,i)=>{t.addSchema(i,e)}))}async getProducts(t,e={}){let i=[];e.product_id=t,i=await this.db.getTable("product").getList({query:e});const a=new Set(i.map((t=>t.product_id))),r=t.filter((t=>!a.has(t))),n=await this.fetchProducts(r);return n&&(await PRHelper.getType().each(n,(async t=>{await this.saveProduct(t)})),i=[...i,...n]),i}async getProduct(t,e={}){e.product_id=t,e.product_url=t;let i=await this.db.getTable("product").getSingle({query:e});return i&&!PRHelper.getTool().isTimePassed(i.fetched_at,24)||(i=await this.fetchProduct(t),await this.saveProduct(i,i.id??null)),i}async saveProduct(t,e=null){const i=this.db.getTable("product");let a=null;a=e?await i.getSingle({query:{id:e}}):await i.getSingle({query:{product_id:t.product_id}}),t.fetched_at=Date.now(),a?i.update(a.id,t):i.add(t)}fetchProduct(t){return new Promise(((e,i)=>{PRHelper.getRequest().restGet("core/retargeting/get-product/").onSuccess(((t,a)=>{a.product?e(a.product):i(null)})).onError((t=>{console.log(t),i(null)})).addNonce().send({product:t})}))}fetchProducts(t){return new Promise(((e,i)=>{PRHelper.getRequest().restGet("core/retargeting/get-products/").onSuccess((t=>{t.products?e(t.products):i(null)})).onError((t=>{console.log(t),i(null)})).addNonce().send({products:t})}))}};const e=class{constructor(t={}){this.db=t.database,this.parentID=t.parentID||0,this.productID=t.productID||0,this.productType=t.productType||"simple",this.eventWeights=t.eventWeights,this.eventMaximums=t.eventMaximums,this.syncInterval=t.syncInterval||3e4,this.interestThreshold=parseInt(t.interestThreshold||30),this.startTime=0,this.dwellTime=0,this.lastY=window.scrollY,this.totalDelta=0,this.scrollDepth=0,this.scrollTimeout=null,this.interactionCount=0,this.initDB(),this.init()}init(){const t=PRHelper.getHook();this.productID&&(this.onScroll=this.onScroll.bind(this),t.on("scroll",this.onScroll),this.handleInteractionClick=this.handleInteractionClick.bind(this),t.on("click",this.handleInteractionClick),this.onLeavePage=this.onLeavePage.bind(this),this.onVisibilityChange=this.onVisibilityChange.bind(this),t.on("beforeunload",this.onLeavePage),t.on("visibilitychange",this.onVisibilityChange)),this.handleLinkClick=this.handleLinkClick.bind(this),t.on("click",this.handleLinkClick,"a[href]"),this.handleCartAction=this.handleCartAction.bind(this),t.on("click",this.handleCartAction,"a[href], button[type=submit]"),this.checkPendingClickOnLoad=this.checkPendingClickOnLoad.bind(this),t.on("load",this.checkPendingClickOnLoad)}stop(){PRHelper.getHook().removeListener("scroll",this.onScroll)}onLeavePage(){"hidden"===document.visibilityState&&(this.dwellTime+=Date.now()-this.startTime),this.addPageEvent()}onVisibilityChange(){"visible"===document.visibilityState?this.onVisible():this.onHidden()}onVisible(){this.startTime=Date.now()}onHidden(){this.startTime&&(this.dwellTime+=Date.now()-this.startTime,this.startTime=0)}handleCartAction(t){const e=PRHelper.getType(),i=PRHelper.getHTML(),a=i.getTarget(t);let r=i.getData(a,"productId");if(e.isEmpty(r)&&i.is(a,"button")&&(r=i.getValue(a)),r){let t="add",e=i.getParent(a,".add_to_cart_button");i.isElement(e)||(e=i.getParent(a,".single_add_to_cart_button")),i.isElement(e)||(t="remove",e=i.getParent(a,".remove_from_cart_button")),i.isElement(e)&&this.addCartEvent(r,productType,parentID,t)}}handleInteractionClick(t){const e=PRHelper.getHTML(),i=e.getTarget(t);if(e.getParent(i,"a[href]"))return;if(e.is(i,"button")&&["submit","reset"].includes(i.type))return;if(e.getParent(i,"form"))return;const a=e.getAttribute(i,"role");(a&&a.includes("tab")||e.is(i,"button")||e.is(i,"select")||e.is(i,"input[type=radio]")||e.is(i,"input[type=button]")||e.is(i,"input[type=checkbox]")||e.is(i,"input[type=checkbox]")||this.isInteractive(i))&&this.interactionCount++}checkPendingClickOnLoad(){if(this.isProductPage()){const t=PRHelper.getStorage().get("pr_pending_click");t&&this.addClickEvent(t.referrer||document.referrer||"")}PRHelper.getStorage().remove("pr_pending_click")}handleLinkClick(t){const e=PRHelper.getHTML(),i=e.getTarget(t),a=e.getAttribute(i,"href");if(!a)return;const r=PRHelper.getSetting().getOption("product_link_pattern","");if(!r)return;if(!a.includes(r))return;const n=a.split(r)[1]?.replace(/\/$/,"");n&&PRHelper.getStorage().set("pr_pending_click",{referrer:window.location.href,timestamp:Date.now()})}isInteractive(t){const e=window.getComputedStyle(t),i="function"==typeof t.onclick||t.hasAttribute("onclick");return["DIV","SPAN","IMG"].includes(t.tagName)&&(i||"pointer"===e.cursor)}onScroll(){this.scrollTimeout||(this.scrollTimeout=setTimeout((()=>{const t=window.scrollY,e=Math.abs(t-this.lastY);this.totalDelta+=e,this.lastY=t,this.scrollDepth=Math.max(this.scrollDepth,(t+window.innerHeight)/document.body.scrollHeight),this.scrollTimeout=null}),200))}getScrollActivity(){const t=document.body.scrollHeight-window.innerHeight;return t<=0?0:this.totalDelta/t}initDB(){const t=this.db.addTable("page_event"),e=this.db.addTable("cart_event"),i=this.db.addTable("click_event"),a=this.db.addTable("interest");t.addSchema("dwell_time").addSchema("scroll_depth").addSchema("scroll_activity").addSchema("interaction_count"),i.addSchema("referrer",{default:"",type:String}),e.addSchema("action",{default:"add",type:String}),a.addSchema("score",{default:0,type:Number});const r=[i,t,e,a];PRHelper.getType().each(r,(t=>{t.addSchema("synced",{default:!1,type:Boolean}).addSchema("parent_id",{default:0,type:Number}).addSchema("product_id",{default:0,type:Number}).addSchema("product_type",{default:"simple",type:String})}))}getInterestedProducts(){return this.db.getTable("interest").getPluck({limit:10,order:"DESC",sortBy:"score",query:{score:{operator:">=",value:this.interestThreshold}}},"product_id")}getLastViewdProducts(t={}){return this.db.getTable("page_event").getPluck({limit:10,order:"DESC",query:t,sortBy:"created_at",groupBy:"product_id"},"product_id")}async addPageEvent(t=!1){if(!this.isProductPage())return;const e=PRHelper.getStorage();if(t){const t=e.get("last_page_event");t&&(this.addEvent("page_event",t,t.product_id,t.product_type||"simple",t.parent_id||0),e.remove("last_page_event"));e.get("last_parent_page_event")}else{const t=this.prepareDataBeforeInsert({synced:!1,dwell_time:this.dwellTime,scroll_depth:this.scrollDepth,scroll_activity:this.getScrollActivity(),interaction_count:this.interactionCount});e.set("last_page_event",t)}}async addClickEvent(t){this.addEvent("click_event",{synced:!1,referrer:t})}async addCartEvent(t,e,i,a){this.addEvent("cart_event",{synced:!1,action:a},t,e,i)}async addEvent(t,e,i=0,a="simple",r=0){const n=this.db.getTable(t),s=this.prepareDataBeforeInsert(e,i,a,r);if(s.id=PRHelper.getTool().generateUUID(),await n.add(s),await this.calculateInterestScore(s.product_id,s.product_type,s.parent_id),!PRHelper.getType().isEmpty(s.parent_id)){const t=this.prepareDataBeforeInsert(e,s.parent_id);s.id=PRHelper.getTool().generateUUID(),await n.add(t),await this.calculateInterestScore(t.product_id,t.product_type)}}prepareDataBeforeInsert(t,e=0,i="simple",a=0){return 0===e&&(i=this.productType,e=this.productID,a=this.parentID),t.product_type=i,t.product_id=parseInt(e),t.parent_id=parseInt(a),t}async calculateInterestScore(t,e="simple",i=0){const a=this.db.getTable("page_event"),r=this.db.getTable("cart_event"),n=this.db.getTable("click_event"),s={query:{product_id:t}},c=await a.getList(s),d=await r.getList(s),o=await n.getList(s),l=d.filter((t=>"add"===t.action)).length,h=d.filter((t=>"remove"===t.action)).length,p={view:c.length,click:o.length,dwell_time:this.sum(c.map((t=>t.dwell_time))),add_to_cart:Math.max(l-h,0),interaction:this.sum(c.map((t=>t.interaction_count))),scroll_depth:this.max(c.map((t=>t.scroll_depth))),scroll_activity:this.max(c.map((t=>t.scroll_activity))),unique_referrers:new Set(o.map((t=>t.referrer))).size};let u=0;for(const t in p){const e=this.eventMaximums[t]??1,i=this.eventWeights[t]??0;u+=Math.min(p[t]/e,1)*i}const g=Math.max(Math.max(...c.map((t=>t.created_at))),o.length?Math.max(...o.map((t=>t.created_at))):0,d.length?Math.max(...d.map((t=>t.created_at))):0),m=(Date.now()-g)/36e5,y=Math.exp(-.1*m),_=Math.ceil(u*y),b=this.db.getTable("interest"),v=await b.getSingle({query:{product_id:t}});let P=!1,S=0;v?(b.update(v.id,{score:_}),S=v.id,P=v.synced||_>=this.interestThreshold):(S=await b.add(this.prepareDataBeforeInsert({score:_,product_id:t},t,e,i)),P=_>=this.interestThreshold),P&&PRHelper.getRequest().restPost("core/retargeting/sync-interest/").onSuccess((async(t,e)=>{b.update(S,{synced:!0})})).onError((t=>{console.warn("Interest score sync failed:",t)})).addNonce().send({score:_,product_id:t,interest_id:S})}mean(t){return t.length?this.sum(t)/t.length:0}sum(t){return t.length?t.reduce(((t,e)=>t+e),0):0}max(t){return t.length?Math.max(...t):0}async sync(){const t=(await db.getAll("events",(t=>!t.synced))).filter((t=>{if("add_to_cart"===t.type)return!0;if("page_view"===t.type&&t.data?.productID){return(this.localInterest[t.data.productID]||0)>=this.interestThreshold}return!1}));t.length&&PRHelper.getRequest().restPost(this.syncPath).onSuccess(((e,i)=>{PRHelper.getType().each(t,(async t=>{await this.db.update("events",t.id,{synced:!0})}))})).onError((t=>{console.warn("Sync failed:",t)})).send({events:t})}initAutoSync(){this.syncInterval>0&&setInterval((()=>this.sync()),this.syncInterval),PRHelper.getHook().on("visibilitychange",(()=>{"hidden"===document.visibilityState&&this.sync()}))}async clear(){await this.db.getTable("interest").clear(),await this.db.getTable("page_event").clear(),await this.db.getTable("cart_event").clear(),await this.db.getTable("click_event").clear()}isProductPage(){return this.productID&&this.productID>0}};!function(){const i=PRHelper.getHook(),a=PRHelper.getHTML(),r=PRHelper.getType(),n=PRHelper.getSetting(),s=PRHelper.getTemplate();i.on("DOMContentLoaded",(async()=>{const i=PRHelper.getDatabase().addDatabase("pr_retargeting"),c=new t({database:i}),d=new e({database:i,parentID:n.getOption("parent_id",0),productID:n.getOption("product_id",0),productType:n.getOption("product_type","simple"),eventWeights:n.getOption("event_weights",{}),syncInterval:n.getOption("sync_interval",30),eventMaximums:n.getOption("event_maximums",{}),interestThreshold:n.getOption("interest_threshold",50)});await i.init(),d.addPageEvent(!0);const o=a.getElements('.pr-tpl[data-type="most-interested"]');a.isList(o)&&d.getInterestedProducts().then((t=>{h(t,o,"retargeting_most_interested")})).catch((t=>console.log(t)));const l=a.getElements('.pr-tpl[data-type="recently-viewed"]');function h(t,e,i){r.isEmpty(t)||r.each(e,(e=>{const n=a.getData(e,"query",{});c.getProducts(t,n).then((t=>{r.isEmpty(t)||s.load(`script.pr-js-tpl#${i}`,{items:t})})).catch((t=>console.log(t)))}))}!r.isEmpty(l)&&a.isList(l)&&d.getLastViewdProducts().then((async t=>{h(t,l,"retargeting_recently_viewed")})).catch((t=>console.log(t)))}))}()})();